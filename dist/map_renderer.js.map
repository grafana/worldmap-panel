{"version":3,"sources":["../src/map_renderer.js"],"names":[],"mappings":"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","file":"map_renderer.js","sourcesContent":["import _ from 'lodash';\nimport L from './leaflet';\nimport './css/leaflet.css!';\n\nexport default function link(scope, elem, attrs, ctrl) {\n  const mapContainer = elem.find('.mapcontainer');\n\n  ctrl.events.on('render', () => {\n    render();\n    ctrl.renderingCompleted();\n  });\n\n  function render() {\n    if (!ctrl.data) return;\n\n    if (!ctrl.map) createMap();\n    resize();\n\n    if (ctrl.mapCenterMoved) panToMapCenter();\n\n    if (!ctrl.legend) createLegend();\n\n    drawCircles();\n  }\n\n  function createMap() {\n    const mapCenter = window.L.latLng(ctrl.panel.mapCenterLatitude, ctrl.panel.mapCenterLongitude);\n    ctrl.map = window.L.map(mapContainer[0], {worldCopyJump: true, center: mapCenter})\n      .fitWorld()\n      .zoomIn(ctrl.panel.initialZoom);\n    ctrl.map.panTo(mapCenter);\n\n    const selectedTileServer = ctrl.tileServers[ctrl.tileServer];\n    window.L.tileLayer(selectedTileServer.url, {\n      maxZoom: 18,\n      subdomains: selectedTileServer.subdomains,\n      reuseTiles: true,\n      detectRetina: true,\n      attribution: selectedTileServer.attribution\n    }).addTo(ctrl.map);\n\n    ctrl.circles = [];\n  }\n\n  function createLegend() {\n    ctrl.legend = window.L.control({position: 'bottomleft'});\n    ctrl.legend.onAdd = () => {\n      ctrl.legend._div = window.L.DomUtil.create('div', 'info legend');\n      ctrl.legend.update();\n      return ctrl.legend._div;\n    };\n\n    ctrl.legend.update = () => {\n      const thresholds = ctrl.data.thresholds;\n      let legendHtml = '';\n      legendHtml += '<i style=\"background:' + ctrl.panel.colors[0] + '\"></i> ' +\n          '&lt; ' + thresholds[0] + '<br>';\n      for (let index = 0; index < thresholds.length; index++) {\n        legendHtml +=\n          '<i style=\"background:' + getColor(thresholds[index] + 1) + '\"></i> ' +\n          thresholds[index] + (thresholds[index + 1] ? '&ndash;' + thresholds[index + 1] + '<br>' : '+');\n      }\n      ctrl.legend._div.innerHTML = legendHtml;\n    };\n\n    ctrl.legend.addTo(ctrl.map);\n  }\n\n  function getColor(value) {\n    for (let index = ctrl.data.thresholds.length; index > 0; index--) {\n      if (value >= ctrl.data.thresholds[index - 1]) {\n        return ctrl.panel.colors[index];\n      }\n    }\n    return _.first(ctrl.panel.colors);\n  }\n\n  function needToRedrawCircles() {\n    if (ctrl.circles.length === 0) return false;\n    if (ctrl.circles.length > 0 && ctrl.circles.length !== ctrl.data.length) return true;\n    const locations = _.map(_.map(ctrl.circles, 'options'), 'location').sort();\n    const dataPoints = _.map(ctrl.data, 'key').sort();\n    return !_.isEqual(locations, dataPoints);\n  }\n\n  function clearCircles() {\n    ctrl.circlesLayer.clearLayers();\n    ctrl.map.removeLayer(ctrl.circlesLayer);\n    ctrl.circles = [];\n  }\n\n  function drawCircles() {\n    if (needToRedrawCircles()) {\n      clearCircles();\n    }\n\n    const circles = [];\n    ctrl.data.forEach(dataPoint => {\n      const location = _.find(ctrl.locations, (loc) => { return loc.key === dataPoint.key; });\n\n      if (!location) return;\n\n      const circle = _.find(ctrl.circles, cir => { return cir.options.location === location.key; });\n\n      if (circle) {\n        circle.setRadius(calcCircleSize(dataPoint.value || 0));\n        circle.setStyle({\n          color: getColor(dataPoint.value),\n          fillColor: getColor(dataPoint.value),\n          fillOpacity: 0.5,\n          location: location.key\n        });\n        circle.unbindPopup();\n        createPopup(circle, location.name, dataPoint.valueRounded);\n      } else {\n        circles.push(createCircle(location, dataPoint));\n      }\n    });\n    ctrl.circlesLayer = window.L.layerGroup(circles).addTo(ctrl.map);\n    ctrl.circles = ctrl.circles.concat(circles);\n  }\n\n  function createCircle(location, dataPoint) {\n    const circle = window.L.circleMarker([location.latitude, location.longitude], {\n      radius: calcCircleSize(dataPoint.value || 0),\n      color: getColor(dataPoint.value),\n      fillColor: getColor(dataPoint.value),\n      fillOpacity: 0.5,\n      location: location.key\n    });\n\n    createPopup(circle, location.name, dataPoint.valueRounded);\n    return circle;\n  }\n\n  function calcCircleSize(dataPointValue) {\n    if (ctrl.data.valueRange === 0) {\n      return ctrl.panel.circleMinSize;\n    }\n\n    const dataFactor = (dataPointValue - ctrl.data.lowestValue) / ctrl.data.valueRange;\n    const circleSizeRange = ctrl.panel.circleMaxSize - ctrl.panel.circleMinSize;\n\n    return (circleSizeRange * dataFactor) + ctrl.panel.circleMinSize;\n  }\n\n  function createPopup(circle, locationName, value) {\n    const unit = value && value === 1 ? ctrl.panel.unitSingular : ctrl.panel.unitPlural;\n    circle.bindPopup(locationName + ': ' + value + ' ' + unit, {'offset': window.L.point(0, -2), 'className': 'worldmap-popup'});\n\n    circle.on('mouseover', function (evt) {\n      const layer = evt.target;\n      layer.bringToFront();\n      this.openPopup();\n    });\n    circle.on('mouseout', function () {\n      circle.closePopup();\n    });\n  }\n\n  function resize() {\n    if (ctrl.map) ctrl.map.invalidateSize();\n  }\n\n  function panToMapCenter() {\n    ctrl.map.panTo([ctrl.panel.mapCenterLatitude, ctrl.panel.mapCenterLongitude]);\n    ctrl.mapCenterMoved = false;\n  }\n}\n"]}