{"version":3,"sources":["../src/worldmap_ctrl.js"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAQ,sB,kBAAA,gB;;AACD,O;;AACA,gB;;AACA,S;;AACA,iB;;AACA,mB;;;;;;;;;;;;;;;;;;;;;AAGD,mB,GAAgB;AACpB,mBAAW,UADS;AAEpB,2BAAmB,CAFC;AAGpB,4BAAoB,CAHA;AAIpB,qBAAa,CAJO;AAKpB,mBAAW,OALS;AAMpB,uBAAe,CANK;AAOpB,uBAAe,EAPK;AAQpB,sBAAc,WARM;AASpB,oBAAY,MATQ;AAUpB,gBAAQ,CAAC,wBAAD,EAA2B,0BAA3B,EAAuD,yBAAvD,CAVY;AAWpB,oBAAY,EAXQ;AAYpB,oBAAY,EAZQ;AAapB,oBAAY,IAbQ;AAcpB,kBAAU;AAdU,O;AAiBhB,iB,GAAc;AAClB,4BAAoB,EAAE,KAAK,4DAAP,EAAqE,aAAa,wIAAlF,EAA4N,YAAY,MAAxO,EADF;AAElB,wBAAgB,EAAC,KAAK,yDAAN,EAAiE,aAAa,wIAA9E,EAAwN,YAAY,MAApO;AAFE,O;AAKd,gB,GAAa;AACjB,oBAAY,EAAC,mBAAmB,CAApB,EAAuB,oBAAoB,CAA3C,EADK;AAEjB,yBAAiB,EAAC,mBAAmB,EAApB,EAAwB,oBAAoB,CAAC,GAA7C,EAFA;AAGjB,kBAAU,EAAC,mBAAmB,EAApB,EAAwB,oBAAoB,EAA5C,EAHO;AAIjB,qBAAa,EAAC,mBAAmB,EAApB,EAAwB,oBAAoB,EAA5C,EAJI;AAKjB,mBAAW,EAAC,mBAAmB,EAApB,EAAwB,oBAAoB,GAA5C;AALM,O;;8BAQN,Y;;;AACX,8BAAY,MAAZ,EAAoB,SAApB,EAA+B,UAA/B,EAA2C;AAAA;;AAAA,sGACnC,MADmC,EAC3B,SAD2B;;AAGzC,gBAAK,cAAL,CAAoB,UAApB;AACA,YAAE,QAAF,CAAW,MAAK,KAAhB,EAAuB,aAAvB;;AAEA,gBAAK,MAAL,CAAY,EAAZ,CAAe,gBAAf,EAAiC,MAAK,cAAL,CAAoB,IAApB,OAAjC;AACA,gBAAK,MAAL,CAAY,EAAZ,CAAe,eAAf,EAAgC,MAAK,cAAL,CAAoB,IAApB,OAAhC;AACA,gBAAK,MAAL,CAAY,EAAZ,CAAe,gBAAf,EAAiC,MAAK,eAAL,CAAqB,IAArB,OAAjC;;AAEA,gBAAK,wBAAL;AAVyC;AAW1C;;;;yCAEc,U,EAAY;AACzB,iBAAK,UAAL,GAAkB,WAAW,IAAX,CAAgB,UAAhB,GAA6B,kBAA7B,GAAkD,cAApE;;AAEA,iBAAK,qBAAL;AACA,iBAAK,WAAL,GAAmB,WAAnB;AACD;;;kDAEuB;AACtB,gBAAI,KAAK,UAAL,KAAoB,cAAxB,EAAwC;AACtC,mBAAK,eAAL,GAAuB,YAAvB;AACD,aAFD,MAEO;AACL,mBAAK,eAAL,GAAuB,EAAvB;AACD;AACF;;;qDAE0B;AAAA;;AACzB,gBAAI,CAAC,KAAK,GAAN,IAAa,KAAK,KAAL,CAAW,YAAX,KAA4B,SAA7C,EAAwD;AACtD,qBAAO,CAAP,CAAS,OAAT,CAAiB,gDAAgD,KAAK,KAAL,CAAW,YAA3D,GAA0E,OAA3F,EAAoG,IAApG,CAAyG,eAAO;AAC9G,uBAAK,SAAL,GAAiB,GAAjB;AACA,uBAAK,MAAL;AACD,eAHD;AAID;AACF;;;4CAEiB;AAChB,iBAAK,OAAL,GAAe,EAAf;AACA,gBAAI,KAAK,YAAT,EAAuB,KAAK,GAAL,CAAS,aAAT,CAAuB,KAAK,YAA5B;AACvB,gBAAI,KAAK,MAAT,EAAiB,KAAK,GAAL,CAAS,YAAT,CAAsB,KAAK,MAA3B;AACjB,iBAAK,MAAL,GAAc,IAAd;AACA,gBAAI,KAAK,GAAT,EAAc,KAAK,GAAL,CAAS,MAAT;AACf;;;2CAEgB;AACf,iBAAK,YAAL,CAAkB,UAAlB,EAA8B,mDAA9B,EAAmF,CAAnF;AACD;;;yCAEc,Q,EAAU;AACvB,iBAAK,MAAL,GAAc,SAAS,GAAT,CAAa,KAAK,aAAL,CAAmB,IAAnB,CAAwB,IAAxB,CAAb,CAAd;AACA,gBAAM,OAAO,EAAb;AACA,gBAAI,KAAK,KAAL,CAAW,YAAX,KAA4B,SAAhC,EAA2C;AACzC,mBAAK,gBAAL,CAAsB,IAAtB;AACD,aAFD,MAEO;AACL,mBAAK,SAAL,CAAe,IAAf;AACD;AACD,iBAAK,IAAL,GAAY,IAAZ;;AAEA,iBAAK,mBAAL;;AAEA,iBAAK,MAAL;AACD;;;2CAEgB,I,EAAM;AAAA;;AACrB,gBAAI,CAAC,KAAK,KAAL,CAAW,UAAZ,IAA0B,CAAC,KAAK,KAAL,CAAW,QAA1C,EAAoD;;AAEpD,gBAAI,KAAK,MAAL,IAAe,KAAK,MAAL,CAAY,MAAZ,GAAqB,CAAxC,EAA2C;AAAA;AACzC,oBAAI,eAAe,CAAnB;AACA,oBAAI,cAAc,OAAO,SAAzB;;AAEA,uBAAK,MAAL,CAAY,CAAZ,EAAe,UAAf,CAA0B,OAA1B,CAAkC,qBAAa;AAC7C,sBAAM,iBAAiB,UAAU,OAAK,KAAL,CAAW,UAArB,CAAvB;AACA,sBAAM,iBAAiB,cAAc,cAAd,CAAvB;;AAEA,sBAAM,YAAY;AAChB,yBAAK,cADW;AAEhB,kCAAc,OAAK,KAAL,CAAW,cAAX,GAA4B,UAAU,OAAK,KAAL,CAAW,cAArB,CAA5B,GAAmE,cAFjE;AAGhB,sCAAkB,eAAe,QAHjB;AAIhB,uCAAmB,eAAe,SAJlB;AAKhB,2BAAO,UAAU,OAAK,KAAL,CAAW,QAArB,CALS;AAMhB,oCAAgB,UAAU,OAAK,KAAL,CAAW,QAArB,CANA;AAOhB,kCAAc;AAPE,mBAAlB;;AAUA,sBAAI,UAAU,KAAV,GAAkB,YAAtB,EAAoC,eAAe,UAAU,KAAzB;AACpC,sBAAI,UAAU,KAAV,GAAkB,WAAtB,EAAmC,cAAc,UAAU,KAAxB;;AAEnC,4BAAU,YAAV,GAAyB,IAAI,UAAJ,CAAe,UAAU,KAAzB,EAAgC,CAAhC,CAAzB;AACA,uBAAK,IAAL,CAAU,SAAV;AACD,iBAnBD;;AAqBA,qBAAK,YAAL,GAAoB,YAApB;AACA,qBAAK,WAAL,GAAmB,WAAnB;AACA,qBAAK,UAAL,GAAkB,eAAe,WAAjC;AA3ByC;AA4B1C;AACF;;;oCAES,I,EAAM;AAAA;;AACd,gBAAI,KAAK,MAAL,IAAe,KAAK,MAAL,CAAY,MAAZ,GAAqB,CAAxC,EAA2C;AAAA;AACzC,oBAAI,eAAe,CAAnB;AACA,oBAAI,cAAc,OAAO,SAAzB;;AAEA,uBAAK,MAAL,CAAY,OAAZ,CAAoB,iBAAS;AAC3B,sBAAM,YAAY,EAAE,IAAF,CAAO,MAAM,UAAb,CAAlB;AACA,sBAAM,YAAY,EAAE,OAAF,CAAU,SAAV,IAAuB,UAAU,CAAV,CAAvB,GAAsC,IAAxD;AACA,sBAAM,WAAW,EAAE,IAAF,CAAO,OAAK,SAAZ,EAAuB,UAAC,GAAD,EAAS;AAAE,2BAAO,IAAI,GAAJ,KAAY,MAAM,KAAzB;AAAiC,mBAAnE,CAAjB;;AAEA,sBAAI,EAAE,QAAF,CAAW,SAAX,CAAJ,EAA2B;AACzB,4BAAQ,GAAR,CAAY,iBAAiB,SAA7B;AACA,yBAAK,IAAL,CAAU,EAAC,KAAK,MAAM,KAAZ,EAAmB,OAAO,CAA1B,EAA6B,gBAAgB,SAA7C,EAAwD,cAAc,CAAtE,EAAV;AACD,mBAHD,MAGO;AACL,wBAAM,YAAY;AAChB,2BAAK,MAAM,KADK;AAEhB,oCAAc,SAAS,IAFP;AAGhB,wCAAkB,SAAS,QAHX;AAIhB,yCAAmB,SAAS,SAJZ;AAKhB,6BAAO,MAAM,KAAN,CAAY,OAAK,KAAL,CAAW,SAAvB,CALS;AAMhB,sCAAgB,SANA;AAOhB,oCAAc;AAPE,qBAAlB;;AAUA,wBAAI,UAAU,KAAV,GAAkB,YAAtB,EAAoC,eAAe,UAAU,KAAzB;AACpC,wBAAI,UAAU,KAAV,GAAkB,WAAtB,EAAmC,cAAc,UAAU,KAAxB;;AAEnC,8BAAU,YAAV,GAAyB,IAAI,UAAJ,CAAe,UAAU,KAAzB,EAAgC,CAAhC,CAAzB;AACA,yBAAK,IAAL,CAAU,SAAV;AACD;AACF,iBAzBD;;AA2BA,qBAAK,YAAL,GAAoB,YAApB;AACA,qBAAK,WAAL,GAAmB,WAAnB;AACA,qBAAK,UAAL,GAAkB,eAAe,WAAjC;AAjCyC;AAkC1C;AACF;;;wCAEa,U,EAAY;AACxB,gBAAM,SAAS,IAAI,UAAJ,CAAe;AAC5B,0BAAY,WAAW,UADK;AAE5B,qBAAO,WAAW;AAFU,aAAf,CAAf;;AAKA,mBAAO,SAAP,GAAmB,OAAO,YAAP,CAAoB,KAAK,KAAL,CAAW,aAA/B,CAAnB;AACA,mBAAO,MAAP;AACD;;;4CAEiB;AAChB,gBAAI,KAAK,KAAL,CAAW,SAAX,KAAyB,QAA7B,EAAuC;AACrC,mBAAK,KAAL,CAAW,iBAAX,GAA+B,WAAW,KAAK,KAAL,CAAW,SAAtB,EAAiC,iBAAhE;AACA,mBAAK,KAAL,CAAW,kBAAX,GAAgC,WAAW,KAAK,KAAL,CAAW,SAAtB,EAAiC,kBAAjE;AACD;AACD,iBAAK,cAAL,GAAsB,IAAtB;AACA,iBAAK,MAAL;AACD;;;oCAES;AACR,iBAAK,GAAL,CAAS,OAAT,CAAiB,KAAK,KAAL,CAAW,WAA5B;AACD;;;yCAEc;AACb,gBAAI,CAAC,KAAK,KAAL,CAAW,UAAhB,EAA4B;AAC1B,mBAAK,GAAL,CAAS,YAAT,CAAsB,KAAK,MAA3B;AACA,mBAAK,MAAL,GAAc,IAAd;AACD;AACD,iBAAK,MAAL;AACD;;;6CAEkB;AACjB,iBAAK,mBAAL;AACA,iBAAK,MAAL,CAAY,MAAZ;AACA,iBAAK,MAAL;AACD;;;gDAEqB;AACpB,iBAAK,IAAL,CAAU,UAAV,GAAuB,KAAK,KAAL,CAAW,UAAX,CAAsB,KAAtB,CAA4B,GAA5B,EAAiC,GAAjC,CAAqC,oBAAY;AACtE,qBAAO,OAAO,SAAS,IAAT,EAAP,CAAP;AACD,aAFsB,CAAvB;AAGD;;;+CAEoB;AACnB,iBAAK,wBAAL;;AAEA,gBAAI,KAAK,KAAL,CAAW,YAAX,KAA4B,SAAhC,EAA2C;AACzC,mBAAK,MAAL;AACD;AACF;;;+BAEI,K,EAAO,I,EAAM,K,EAAO,I,EAAM;AAC7B,wBAAY,KAAZ,EAAmB,IAAnB,EAAyB,KAAzB,EAAgC,IAAhC;AACD;;;;QA9L+B,gB;;;;AAiMlC,mBAAa,WAAb,GAA2B,aAA3B","file":"worldmap_ctrl.js","sourcesContent":["import {MetricsPanelCtrl} from 'app/plugins/sdk';\nimport _ from 'lodash';\nimport TimeSeries from 'app/core/time_series2';\nimport kbn from 'app/core/utils/kbn';\nimport mapRenderer from './map_renderer';\nimport decodeGeoHash from './geohash';\nimport './css/worldmap-panel.css!';\n\nconst panelDefaults = {\n  mapCenter: '(0째, 0째)',\n  mapCenterLatitude: 0,\n  mapCenterLongitude: 0,\n  initialZoom: 1,\n  valueName: 'total',\n  circleMinSize: 2,\n  circleMaxSize: 30,\n  locationData: 'countries',\n  thresholds: '0,10',\n  colors: ['rgba(245, 54, 54, 0.9)', 'rgba(237, 129, 40, 0.89)', 'rgba(50, 172, 45, 0.97)'],\n  unitSingle: '',\n  unitPlural: '',\n  showLegend: true,\n  esMetric: 'Count'\n};\n\nconst tileServers = {\n  'CartoDB Positron': { url: 'http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', attribution: '&copy; <a href=\"http://www.openstreetmap.org/copyright\">OpenStreetMap</a> &copy; <a href=\"http://cartodb.com/attributions\">CartoDB</a>', subdomains: 'abcd'},\n  'CartoDB Dark': {url: 'http://a.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png', attribution: '&copy; <a href=\"http://www.openstreetmap.org/copyright\">OpenStreetMap</a> &copy; <a href=\"http://cartodb.com/attributions\">CartoDB</a>', subdomains: '1234'}\n};\n\nconst mapCenters = {\n  '(0째, 0째)': {mapCenterLatitude: 0, mapCenterLongitude: 0},\n  'North America': {mapCenterLatitude: 40, mapCenterLongitude: -100},\n  'Europe': {mapCenterLatitude: 46, mapCenterLongitude: 14},\n  'West Asia': {mapCenterLatitude: 26, mapCenterLongitude: 53},\n  'SE Asia': {mapCenterLatitude: 10, mapCenterLongitude: 106}\n};\n\nexport class WorldmapCtrl extends MetricsPanelCtrl {\n  constructor($scope, $injector, contextSrv) {\n    super($scope, $injector);\n\n    this.setMapProvider(contextSrv);\n    _.defaults(this.panel, panelDefaults);\n\n    this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\n    this.events.on('data-received', this.onDataReceived.bind(this));\n    this.events.on('panel-teardown', this.onPanelTeardown.bind(this));\n\n    this.loadLocationDataFromFile();\n  }\n\n  setMapProvider(contextSrv) {\n    this.tileServer = contextSrv.user.lightTheme ? 'CartoDB Positron' : 'CartoDB Dark';\n\n    this.setMapSaturationClass();\n    this.tileServers = tileServers;\n  }\n\n  setMapSaturationClass() {\n    if (this.tileServer === 'CartoDB Dark') {\n      this.saturationClass = 'map-darken';\n    } else {\n      this.saturationClass = '';\n    }\n  }\n\n  loadLocationDataFromFile() {\n    if (!this.map && this.panel.locationData !== 'geohash') {\n      window.$.getJSON('public/plugins/grafana-worldmap-panel/data/' + this.panel.locationData + '.json').then(res => {\n        this.locations = res;\n        this.render();\n      });\n    }\n  }\n\n  onPanelTeardown() {\n    this.circles = [];\n    if (this.circlesLayer) this.map.removeCircles(this.circlesLayer);\n    if (this.legend) this.map.removeLegend(this.legend);\n    this.legend = null;\n    if (this.map) this.map.remove();\n  }\n\n  onInitEditMode() {\n    this.addEditorTab('Worldmap', 'public/plugins/grafana-worldmap-panel/editor.html', 2);\n  }\n\n  onDataReceived(dataList) {\n    this.series = dataList.map(this.seriesHandler.bind(this));\n    const data = [];\n    if (this.panel.locationData === 'geohash') {\n      this.setGeohashValues(data);\n    } else {\n      this.setValues(data);\n    }\n    this.data = data;\n\n    this.updateThresholdData();\n\n    this.render();\n  }\n\n  setGeohashValues(data) {\n    if (!this.panel.esGeoPoint || !this.panel.esMetric) return;\n\n    if (this.series && this.series.length > 0) {\n      let highestValue = 0;\n      let lowestValue = Number.MAX_VALUE;\n\n      this.series[0].datapoints.forEach(datapoint => {\n        const encodedGeohash = datapoint[this.panel.esGeoPoint];\n        const decodedGeohash = decodeGeoHash(encodedGeohash);\n\n        const dataValue = {\n          key: encodedGeohash,\n          locationName: this.panel.esLocationName ? datapoint[this.panel.esLocationName] : encodedGeohash,\n          locationLatitude: decodedGeohash.latitude,\n          locationLongitude: decodedGeohash.longitude,\n          value: datapoint[this.panel.esMetric],\n          valueFormatted: datapoint[this.panel.esMetric],\n          valueRounded: 0\n        };\n\n        if (dataValue.value > highestValue) highestValue = dataValue.value;\n        if (dataValue.value < lowestValue) lowestValue = dataValue.value;\n\n        dataValue.valueRounded = kbn.roundValue(dataValue.value, 0);\n        data.push(dataValue);\n      });\n\n      data.highestValue = highestValue;\n      data.lowestValue = lowestValue;\n      data.valueRange = highestValue - lowestValue;\n    }\n  }\n\n  setValues(data) {\n    if (this.series && this.series.length > 0) {\n      let highestValue = 0;\n      let lowestValue = Number.MAX_VALUE;\n\n      this.series.forEach(serie => {\n        const lastPoint = _.last(serie.datapoints);\n        const lastValue = _.isArray(lastPoint) ? lastPoint[0] : null;\n        const location = _.find(this.locations, (loc) => { return loc.key === serie.alias; });\n\n        if (_.isString(lastValue)) {\n          console.log('was string: ' + lastValue);\n          data.push({key: serie.alias, value: 0, valueFormatted: lastValue, valueRounded: 0});\n        } else {\n          const dataValue = {\n            key: serie.alias,\n            locationName: location.name,\n            locationLatitude: location.latitude,\n            locationLongitude: location.longitude,\n            value: serie.stats[this.panel.valueName],\n            valueFormatted: lastValue,\n            valueRounded: 0\n          };\n\n          if (dataValue.value > highestValue) highestValue = dataValue.value;\n          if (dataValue.value < lowestValue) lowestValue = dataValue.value;\n\n          dataValue.valueRounded = kbn.roundValue(dataValue.value, 0);\n          data.push(dataValue);\n        }\n      });\n\n      data.highestValue = highestValue;\n      data.lowestValue = lowestValue;\n      data.valueRange = highestValue - lowestValue;\n    }\n  }\n\n  seriesHandler(seriesData) {\n    const series = new TimeSeries({\n      datapoints: seriesData.datapoints,\n      alias: seriesData.target,\n    });\n\n    series.flotpairs = series.getFlotPairs(this.panel.nullPointMode);\n    return series;\n  }\n\n  setNewMapCenter() {\n    if (this.panel.mapCenter !== 'custom') {\n      this.panel.mapCenterLatitude = mapCenters[this.panel.mapCenter].mapCenterLatitude;\n      this.panel.mapCenterLongitude = mapCenters[this.panel.mapCenter].mapCenterLongitude;\n    }\n    this.mapCenterMoved = true;\n    this.render();\n  }\n\n  setZoom() {\n    this.map.setZoom(this.panel.initialZoom);\n  }\n\n  toggleLegend() {\n    if (!this.panel.showLegend) {\n      this.map.removeLegend(this.legend);\n      this.legend = null;\n    }\n    this.render();\n  }\n\n  changeThresholds() {\n    this.updateThresholdData();\n    this.legend.update();\n    this.render();\n  }\n\n  updateThresholdData() {\n    this.data.thresholds = this.panel.thresholds.split(',').map(strValue => {\n      return Number(strValue.trim());\n    });\n  }\n\n  changeLocationData() {\n    this.loadLocationDataFromFile();\n\n    if (this.panel.locationData === 'geohash') {\n      this.render();\n    }\n  }\n\n  link(scope, elem, attrs, ctrl) {\n    mapRenderer(scope, elem, attrs, ctrl);\n  }\n}\n\nWorldmapCtrl.templateUrl = 'module.html';\n"]}